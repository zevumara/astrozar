const defaultUser={decks:{triangle:null,square:null,circle:null},query:null,target:null,timer:null,hodling:!1,triangle:null,square:null,circle:null,slide:0,id:null,debug:1},names=["Mirror","Rainbow","Eye","Staff","Void","Dodecahedron","Dagger","Plant","Heart","Gem"];let user=JSON.parse(localStorage.getItem("user"))||{...defaultUser};const swiper=new Swiper("main",{speed:600,allowSlideNext:!1,allowSlidePrev:!1,autoHeight:!0,direction:"vertical",animating:!1,initialSlide:0}),deckSwiper=new Swiper("#swiper-deck",{effect:"cards",grabCursor:!1,mousewheel:!0,enabled:!1,keyboard:!0,initialSlide:5});function $(e){return document.querySelector(e)}function getRandomNumber(){const e=self.crypto.getRandomValues(new Uint32Array(1)).toString(),t=Math.floor(Math.random()*e.length);return parseInt(e.charAt(t),10)}async function share(e){await image.load(["background-stars.webp"]),$("#btnAstrozar a").href=window.appConfig.apiUrl,allFilesLoaded=!0;const t=await fetch(`${window.appConfig.apiUrl}share/${e}`);if(t.ok){const e=await t.json();$("#share .query").innerText=e.query,$("#share .answer span").innerText=e.answer,$("#share .number h2").innerText=e.number,$("#share .answer_number").innerText=$("#answer .answer_number").innerText,swiper.allowSlideNext=!0,swiper.slideTo(6,0),swiper.allowSlideNext=!1,animate("#loader .icon","backOutDown"),animate(".curtain.left","fadeOutLeft"),await animate(".curtain.right","fadeOutRight"),$("#loader").classList.add("hide")}}function restore(){$("#query").value=user.query,"number"==typeof user.circle&&setupCard("circle"),"number"==typeof user.square&&setupCard("square"),"number"==typeof user.triangle&&setupCard("triangle"),user.slide<5&&(swiper.allowSlideNext=!0,swiper.slideTo(user.slide,1e3),swiper.allowSlideNext=!1,tooltip.show("slots","zoomInDown")),$("#background").classList.add("universe"),user.answer?(console.log("answer",user.answer),sound.play("the-answer.ogg"),showAnswer()):"number"==typeof user.triangle&&"number"==typeof user.square&&"number"==typeof user.circle&&(sound.play("alea-iacta-est.ogg"),swiper.allowSlideNext=!0,swiper.slideTo(4,1400),swiper.allowSlideNext=!1,aleaIactaEst(!0))}function save(e){user.slide=e,localStorage.setItem("user",JSON.stringify(user)),localStorage.setItem("lastSlide",e)}function drawYourCards(){if(!user.query)return;setupSlot("triangle"),setupSlot("circle"),setupSlot("square");const e=localStorage.getItem("shuffling-cards")?1500:3e3;setTimeout((()=>{nextSlide(),tooltip.show("slots","zoomInDown"),localStorage.setItem("shuffling-cards",1)}),e),nextSlide(),user.decks.circle=generateDeck(),user.decks.square=generateDeck(),user.decks.triangle=generateDeck(),save(3)}function generateDeck(){const e=[];for(let t=0;t<10;t++){let t;do{t=getRandomNumber()}while(e.includes(t));e.push(t)}return e}function showDeck(e){null===user[e]&&(sound.play("open.ogg"),user.target=e,$("#deck").classList.remove("triangle"),$("#deck").classList.remove("square"),$("#deck").classList.remove("circle"),$("#deck").classList.add(e),$("#deck").classList.add("appear"),tooltip.hide("slots"),tooltip.show("drag"),deckSwiper.slideTo(5,0),deckSwiper.update(),deckSwiper.update(),deckSwiper.enable())}async function chooseCard(){user.target&&(user.holding=!1,$("#hold").classList.add("hide"),tooltip.hide("hold"),sound.play("chosen.ogg",!0),user.decks.circle=generateDeck(),user.decks.square=generateDeck(),user.decks.triangle=generateDeck(),user[user.target]=user.decks[user.target][deckSwiper.activeIndex],save(3),$("#deck").classList.remove("appear"),$("#card-back").classList.remove("triangle"),$("#card-back").classList.remove("circle"),$("#card-back").classList.remove("square"),$("#card-back").classList.add(user.target),$("#card-front").classList.remove("triangle"),$("#card-front").classList.remove("circle"),$("#card-front").classList.remove("square"),$("#card-front").classList.add(user.target),$("#card-front .number").innerText=user[user.target],"circle"===user.target&&($("#card-front .text").innerText=names[user[user.target]]),$("#chosen").classList.remove("animate__animated","animate__fadeOut","hide"),await animate("#card-back","wobble"),await animate("#card-back","flipOutY"),sound.play("reveal.ogg"),$("#card-back").classList.add("hide"),$("#card-front").classList.remove("hide"),await animate("#card-front","flipInY"),await animate("#card-front","zoomOutUp"),$("#card-front").classList.add("hide"),setupCard(user.target),tooltip.show("complete","zoomInUp"),localStorage.setItem("tooltip-complete",1),$("#chosen").classList.add("hide"),"number"==typeof user.triangle&&"number"==typeof user.square&&"number"==typeof user.circle&&aleaIactaEst())}function setupCard(e){$(`#slot-${e}`).classList.remove("slot"),$(`#slot-${e}`).classList.add("card","front"),$("#card-back").classList.remove("hide"),$(`#slot-${e} .number`).innerText=user[e],"circle"===e&&($(`#slot-${e} .text`).innerText=names[user[e]]),$(`#slot-${e}`).classList.add("done"),$(`#slot-${e}`).addEventListener("mousemove",handleMove),$(`#slot-${e}`).addEventListener("touchmove",handleMove),$(`#slot-${e}`).addEventListener("mouseout",handleEnd),$(`#slot-${e}`).addEventListener("touchend",handleEnd),$(`#slot-${e}`).addEventListener("touchcancel",handleEnd)}function setupSlot(e){$(`#slot-${e}`).classList.remove("done"),$(`#slot-${e}`).classList.remove("card"),$(`#slot-${e}`).classList.remove("front"),$(`#slot-${e}`).classList.add("slot"),$(`#slot-${e} .number`).innerText="","circle"===e&&($(`#slot-${e} .text`).innerText=""),$(`#slot-${e}`).removeEventListener("mousemove",handleMove),$(`#slot-${e}`).removeEventListener("touchmove",handleMove),$(`#slot-${e}`).removeEventListener("mouseout",handleEnd),$(`#slot-${e}`).removeEventListener("touchend",handleEnd),$(`#slot-${e}`).removeEventListener("touchcancel",handleEnd)}function nextSlide(){swiper.allowSlideNext=!0,swiper.slideNext(600),swiper.allowSlideNext=!1}function showAnswer(){user.query&&user.answer&&($("#answer .query").innerText=user.query,$("#answer .answer span").innerText=user.answer,$("#answer .number h2").innerText=`${user.triangle} ${user.circle} ${user.square}`,$("#btnShare").href=`${window.appConfig.apiUrl}?share=${user.id}`,localStorage.removeItem("user"),user={...defaultUser},swiper.allowSlideNext=!0,swiper.slideNext(1400),swiper.allowSlideNext=!1)}function aleaIactaEst(e=!1){e||(setTimeout((()=>{sound.play("button.ogg",!0),$("#flash").classList.remove("hide"),setTimeout((()=>{tooltip.hide("complete"),$("#slot-triangle").classList.add("complete"),$("#slot-circle").classList.add("complete"),$("#slot-square").classList.add("complete"),$("#flash").classList.add("hide")}),250)}),600),setTimeout((()=>{sound.play("alea-iacta-est.ogg"),setTimeout((()=>{save(5),swiper.allowSlideNext=!0,swiper.slideNext(1400),swiper.allowSlideNext=!1}),4500)}),3500));const t=performance.now();let s,a=13500;fetch(`${window.appConfig.apiUrl}query`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:user.query,c:user.circle,t:user.triangle,s:user.square})}).then((e=>{if(!e.ok)throw new Error(`Error: ${e.status}`);return e.json()})).then((e=>{user.id=e.id,user.answer=e.answer,s=performance.now(),a=Math.max(a-(s-t),0),user.debug&&console.log("Delay:",a),setTimeout((()=>{sound.play("the-answer.ogg")}),a),setTimeout(showAnswer,a+700)})).catch((()=>{tryAgain(a)}))}function tryAgain(e){user.debug&&console.log(`Error. Trying again in ${e}...`),setTimeout((()=>{fetch(`${window.appConfig.apiUrl}query`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:user.query,c:user.circle,t:user.triangle,s:user.square})}).then((e=>{if(!e.ok)throw new Error(`Error: ${e.status}`);return e.json()})).then((e=>{user.id=e.id,user.answer=e.answer,sound.play("the-answer.ogg"),setTimeout(showAnswer,700)})).catch((()=>{tryAgain(2500)}))}),e)}function animate(e,t,s="animate__"){return new Promise((a=>{const o=`${s}${t}`,n=$(e);n.classList.add(`${s}animated`,o),n.addEventListener("animationend",(function(e){e.stopPropagation(),n.classList.remove(`${s}animated`,o),a("Animation ended")}),{once:!0})}))}function initHold(){user.hodling||(sound.play("holding.ogg"),$("#hold").classList.remove("hide"),setTimeout((()=>{$("#hold .progress").classList.add("animate")}),100),user.timer=setTimeout(chooseCard,1200),user.holding=!0)}const sound={context:null,files:null,playing:null,load:async function(e){const t={},s=e.map((async e=>{user.debug&&console.log(`Loading "sfx/${e}" ...`);const s=new Audio;await new Promise((a=>{s.addEventListener("canplaythrough",(function(){t[e]=s,a()})),s.src=`sfx/${e}`}))}));await Promise.all(s),user.debug&&console.log("All sound files are loaded:",t),this.files=t},stop:function(){this.playing&&(this.playing.pause(),this.playing.currentTime=0)},play:function(e,t=!0,s=1,a=!1){this.context||(this.context=new(window.AudioContext||window.webkitAudioContext));const o=this.files[e];if(this.playing=o,o)if(o.sourceNode||(o.sourceNode=this.context.createMediaElementSource(o),o.sourceNode.connect(this.context.destination)),t){const e=new Audio(o.src);e.addEventListener("ended",(function(){this.remove()})),e.volume=s,e.loop=a,e.play()}else o.volume=s,o.loop=a,o.play();else console.error(`The sound "${e}" has not been preloaded.`)}},image={files:null,load:async function(e){const t={},s=e.map((async e=>{user.debug&&console.log(`Loading "img/${e}" ...`);const s=new Image;await new Promise((a=>{s.addEventListener("load",(function(){t[e]=s,a()})),s.src=`img/${e}`}))}));await Promise.all(s),user.debug&&console.log("All image files are loaded:",t),this.files=t},use:function(e){return this.files[e]}},language={texts:null,htmls:null,load:async function(e){const t=await fetch(`lang/${e}.json`),s=await t.json();this.texts=s.text;for(const e in this.texts){const t=$(`.${e}`);t&&(t.innerText=this.texts[e])}this.htmls=s.html;for(const e in this.htmls){const t=$(`.${e}`);t&&(t.innerHTML=this.htmls[e])}const a=s.placeholder;for(const e in a){const t=$(`.${e}`);t&&t.setAttribute("placeholder",a[e])}}},tooltip={show:function(e,t="zoomInDown",s=1e3){localStorage.getItem(`tooltip-${e}`)||setTimeout((async()=>{$(`#tooltip-${e}`).classList.remove("hide"),await animate(`#tooltip-${e}`,t),$(`#tooltip-${e}`).classList.add("animated")}),s)},hide:function(e,t="zoomOut",s=0){setTimeout((async()=>{$(`#tooltip-${e}`).classList.remove("animated"),await animate(`#tooltip-${e}`,t),$(`#tooltip-${e}`).classList.add("hide"),localStorage.setItem(`tooltip-${e}`,1)}),s)}};$("#btnAsk").onclick=e=>{e.preventDefault(),e.target.classList.contains("disabled")||(playingMusic||(playingMusic=!0,sound.play("ambience.mp3",!0,.1,!0)),sound.play("button.ogg",!0),setTimeout((()=>{e.target.classList.remove("pulse"),e.target.classList.add("disabled"),$("#flash").classList.remove("hide"),setTimeout((()=>{$("#flash").classList.add("hide")}),250),setTimeout((()=>{window.innerWidth>=767&&$("#query").focus(),nextSlide()}),400)}),200))},$("textarea").onkeydown=e=>{if(13===e.keyCode){e.preventDefault();const t=e.target.value.length;t>15&&t<76&&(sound.play("button.ogg",!0),setTimeout((()=>{$("#btnDraw").classList.remove("pulse"),$("#btnDraw").classList.add("disabled"),$("#flash").classList.remove("hide"),setTimeout((()=>{$("#flash").classList.add("hide")}),250),setTimeout((()=>{drawYourCards()}),400)}),200))}},$("textarea").oninput=e=>{const t=e.target.value.length;sound.play("key.ogg",!0),t>15&&t<=76?($("#btnDraw").innerText=language.texts.concern_button,user.query=e.target.value,$("#btnDraw").classList.contains("disabled")&&($("#btnDraw").classList.remove("disabled"),$("#btnDraw").classList.add("pulse"))):(t<15?$("#btnDraw").innerText=language.texts.expand_question:t>76&&($("#btnDraw").innerText=language.texts.resume_question),user.query=null,$("#btnDraw").classList.contains("disabled")||($("#btnDraw").classList.add("disabled"),$("#btnDraw").classList.remove("pulse")))},$("#btnDraw").onclick=e=>{e.preventDefault(),e.target.classList.contains("disabled")||(sound.play("button.ogg",!0),setTimeout((()=>{e.target.classList.remove("pulse"),e.target.classList.add("disabled"),$("#flash").classList.remove("hide"),setTimeout((()=>{$("#flash").classList.add("hide")}),250),setTimeout((()=>{drawYourCards()}),400)}),200))},$("#btnBack").onclick=()=>{sound.play("close.ogg"),$("#deck").classList.remove("appear"),deckSwiper.disable()},$("#swiper-deck").onpointerdown=()=>{$("#swiper-deck").style.cursor="grabbing",$("#hold .progress").classList.remove("animate"),user.timer=setTimeout(initHold,600)},document.body.onpointerup=()=>{$("#swiper-deck").style.cursor="grab",clearTimeout(user.timer),user.holding&&(sound.stop(),$("#hold").classList.add("hide"),user.holding=!1)},$("#btnShare").onclick=e=>{e.preventDefault(),navigator.clipboard.writeText(e.target.href)},$("#btnAskMeAgain").onclick=e=>{e.preventDefault(),$("#query").value="",window.innerWidth>=767&&$("#query").focus(),$("#btnDraw").classList.add("disabled"),$("#btnDraw").classList.remove("pulse"),swiper.allowSlidePrev=!0,swiper.slideTo(1,1e3),swiper.allowSlidePrev=!1},$("#slot-triangle").onclick=e=>{e.target.classList.contains("done")||showDeck("triangle")},$("#slot-circle").onclick=e=>{e.target.classList.contains("done")||showDeck("circle")},$("#slot-square").onclick=e=>{e.target.classList.contains("done")||showDeck("square")},$(".slot.triangle").onmouseenter=e=>{e.target.classList.contains("done")||sound.play("slot-hover.ogg")},$(".slot.circle").onmouseenter=e=>{e.target.classList.contains("done")||sound.play("slot-hover.ogg")},$(".slot.square").onmouseenter=e=>{e.target.classList.contains("done")||sound.play("slot-hover.ogg")},deckSwiper.on("slideChange",(()=>{sound.play("shuffling.ogg"),tooltip.hide("drag"),tooltip.show("hold","zoomInUp",2e3)}));const sfxHoverButtons=document.querySelectorAll(".sfx-hover");sfxHoverButtons.forEach((e=>{e.onmouseenter=()=>{e.classList.contains("disabled")||sound.play("input.ogg")}}));const cards=document.querySelectorAll("#slots .card.front"),style=document.querySelector(".hover-card-effect");function handleMove(e){let t=[e.offsetX,e.offsetY];e.preventDefault(),"touchmove"===e.type&&(t=[e.touches[0].clientX,e.touches[0].clientY]);const s=this,a=t[0],o=t[1],n=s.offsetHeight,r=s.offsetWidth,i=Math.abs(Math.floor(100/r*a)-100),l=Math.abs(Math.floor(100/n*o)-100),c=50-i+(50-l),d=50+(i-50)/1.5,u=50+(l-50)/1.5,g=`transform: rotateX(${(u-50)/2*-1}deg) rotateY(${(d-50)/1.5*.5}deg)`,m=`.card.front:hover:before { ${`background-position: ${d}% ${u}%;`} }\n          .card.front:hover:after { ${`background-position: ${50+(i-50)/7}% ${50+(l-50)/7}%;`} ${`opacity: ${(20+1.5*Math.abs(c))/100};`} }`;if(cards.forEach((function(e){e.classList.remove("active"),e.classList.remove("animated"),e.removeAttribute("style")})),s.classList.remove("animated"),s.setAttribute("style",g),style.innerHTML=m,"touchmove"===e.type)return!1;clearTimeout(user.timer)}function handleEnd(){const e=this;style.innerHTML="",e.removeAttribute("style"),user.timer=setTimeout((function(){e.classList.add("animated")}),2500)}let allFilesLoaded=!1,playingMusic=!1;window.addEventListener("load",(async()=>{const e="es"===navigator.language.slice(0,2)?"es":"en";await language.load(e);const t=new URL(window.location.href).searchParams.get("share");t?share(t):(await sound.load(["the-answer.ogg","alea-iacta-est.ogg","reveal.ogg","open.ogg","close.ogg","chosen.ogg","holding.ogg","shuffling.ogg","slot-hover.ogg","button.ogg","input.ogg","key.ogg","ambience.mp3"]),await image.load(["background-stars.webp","astrozar.webp","bg-card.webp","icon-grabbing.webp","icon-move.webp","icon-pointer.webp","holo.webp","sparkles.webp"]),allFilesLoaded=!0,animate("#loader .icon","backOutDown"),animate(".curtain.left","fadeOutLeft"),await animate(".curtain.right","fadeOutRight"),$("#loader").classList.add("hide"),user.slide&&restore(),console.log(window.appConfig.apiUrl))}));